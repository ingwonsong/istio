{
  "apiVersion": "networking.istio.io/v1alpha3",
  "kind": "EnvoyFilter",
  "metadata": {
    "creationTimestamp": null,
    "name": "cap-e2e-codelabapikeys.sandbox.googleapis.com-envoy-filter",
    "namespace": "istio-system"
  },
  "spec": {
    "configPatches": [
      {
        "applyTo": "HTTP_FILTER",
        "match": {
          "context": "GATEWAY",
          "listener": {
            "filterChain": {
              "filter": {
                "name": "envoy.filters.network.http_connection_manager",
                "subFilter": {
                  "name": "envoy.filters.http.router"
                }
              }
            },
            "portNumber": 8080
          }
        },
        "patch": {
          "operation": "INSERT_BEFORE",
          "value": {
            "name": "envoy.filters.http.grpc_web"
          }
        }
      },
      {
        "applyTo": "HTTP_FILTER",
        "match": {
          "context": "GATEWAY",
          "listener": {
            "filterChain": {
              "filter": {
                "name": "envoy.filters.network.http_connection_manager",
                "subFilter": {
                  "name": "envoy.filters.http.router"
                }
              }
            },
            "portNumber": 8080
          }
        },
        "patch": {
          "operation": "INSERT_BEFORE",
          "value": {
            "name": "envoy.filters.http.grpc_json_transcoder",
            "typedConfig": {
              "@type": "type.googleapis.com/envoy.extensions.filters.http.grpc_json_transcoder.v3.GrpcJsonTranscoder",
              "autoMapping": true,
              "convertGrpcStatus": true,
              "ignoredQueryParameters": [
                "$key",
                "key"
              ],
              "matchUnregisteredCustomVerb": true,
              "printOptions": {},
              "protoDescriptor": "/etc/istio/proxy/apikey_grpc_asm_e2e_config_descriptor",
              "queryParamUnescapePlus": true,
              "services": [
                "google.example.apikeys.v1.ApiKeys",
                "google.discovery.Discovery"
              ]
            }
          }
        }
      },
      {
        "applyTo": "HTTP_FILTER",
        "match": {
          "context": "GATEWAY",
          "listener": {
            "filterChain": {
              "filter": {
                "name": "envoy.filters.network.http_connection_manager",
                "subFilter": {
                  "name": "envoy.filters.http.router"
                }
              }
            },
            "portNumber": 8080
          }
        },
        "patch": {
          "operation": "INSERT_BEFORE",
          "value": {
            "name": "com.google.service_control_v2_filter",
            "typedConfig": {
              "@type": "type.googleapis.com/udpa.type.v1.TypedStruct",
              "typeUrl": "type.googleapis.com/net.envoy.proto.service_control_v2.FilterConfig",
              "value": {
                "checkCacheConfig": {},
                "estubsGrpc": {
                  "clientRootCertPath": "/roots.pem",
                  "targetUri": "servicecontrol.googleapis.com:443"
                },
                "generatedHeaderPrefix": "X-Endpoint-",
                "imdsUri": {
                  "cluster": "metadata-cluster",
                  "timeout": "30s",
                  "uri": "http://169.254.169.254"
                },
                "reportBatchConfig": {},
                "requirements": [
                  {
                    "apiName": "google.example.apikeys.v1.ApiKeys",
                    "apiVersion": "v1",
                    "metricCosts": [
                      {
                        "cost": "1",
                        "name": "codelabapikeys.googleapis.com/requests"
                      }
                    ],
                    "operationName": "google.example.apikeys.v1.ApiKeys.ListApiKeys",
                    "serviceName": "cap-e2e-codelabapikeys.sandbox.googleapis.com"
                  },
                  {
                    "apiName": "google.example.apikeys.v1.ApiKeys",
                    "apiVersion": "v1",
                    "metricCosts": [
                      {
                        "cost": "1",
                        "name": "codelabapikeys.googleapis.com/requests"
                      }
                    ],
                    "operationName": "google.example.apikeys.v1.ApiKeys.GetApiKey",
                    "serviceName": "cap-e2e-codelabapikeys.sandbox.googleapis.com"
                  },
                  {
                    "apiName": "google.example.apikeys.v1.ApiKeys",
                    "apiVersion": "v1",
                    "metricCosts": [
                      {
                        "cost": "1",
                        "name": "codelabapikeys.googleapis.com/requests"
                      }
                    ],
                    "operationName": "google.example.apikeys.v1.ApiKeys.CreateApiKey",
                    "serviceName": "cap-e2e-codelabapikeys.sandbox.googleapis.com"
                  },
                  {
                    "apiName": "google.example.apikeys.v1.ApiKeys",
                    "apiVersion": "v1",
                    "metricCosts": [
                      {
                        "cost": "1",
                        "name": "codelabapikeys.googleapis.com/update_requests"
                      }
                    ],
                    "operationName": "google.example.apikeys.v1.ApiKeys.UpdateApiKey",
                    "serviceName": "cap-e2e-codelabapikeys.sandbox.googleapis.com"
                  },
                  {
                    "apiName": "google.example.apikeys.v1.ApiKeys",
                    "apiVersion": "v1",
                    "metricCosts": [
                      {
                        "cost": "1",
                        "name": "codelabapikeys.googleapis.com/requests"
                      }
                    ],
                    "operationName": "google.example.apikeys.v1.ApiKeys.DeleteApiKey",
                    "serviceName": "cap-e2e-codelabapikeys.sandbox.googleapis.com"
                  },
                  {
                    "apiName": "google.discovery.Discovery",
                    "apiVersion": "v1",
                    "consumerIdBehavior": "CONSUMER_ID_OPTIONAL",
                    "operationName": "google.discovery.Discovery.GetDiscovery",
                    "serviceName": "cap-e2e-codelabapikeys.sandbox.googleapis.com"
                  },
                  {
                    "apiName": "google.discovery.Discovery",
                    "apiVersion": "v1",
                    "consumerIdBehavior": "CONSUMER_ID_OPTIONAL",
                    "operationName": "google.discovery.Discovery.GetDiscoveryRest",
                    "serviceName": "cap-e2e-codelabapikeys.sandbox.googleapis.com"
                  }
                ],
                "scCallingConfig": {
                  "networkFailOpen": true
                },
                "services": [
                  {
                    "backendProtocol": "grpc",
                    "jwtPayloadMetadataName": "jwt_payloads",
                    "producerProjectId": "cloud-api-proxy-testing",
                    "serviceConfigId": "latest",
                    "serviceName": "cap-e2e-codelabapikeys.sandbox.googleapis.com"
                  }
                ]
              }
            }
          }
        }
      },
      {
        "applyTo": "LISTENER",
        "match": {
          "context": "GATEWAY",
          "listener": {
            "portNumber": 8080
          }
        },
        "patch": {
          "operation": "MERGE",
          "value": {
            "metadata": {
              "typedFilterMetadata": {
                "com.google.cloudesf.service_config": {
                  "@type": "type.googleapis.com/udpa.type.v1.TypedStruct",
                  "typeUrl": "type.googleapis.com/net.envoy.proto.cloudesf.ServiceConfigDataSource",
                  "value": {
                    "serviceConfigPath": "/etc/istio/proxy/_apikey_grpc_asm_e2e_config_service.txtpb"
                  }
                }
              }
            }
          }
        }
      }
    ]
  },
  "status": {}
}