# A custom overlay file that is modified and then passed to scriptaro.
# This is done by via go templates.
# This file is only relevant when CLOUDSDK_API_ENDPOINT_OVERRIDES_CONTAINER is set.
# scriptaro is built for prod installation only, so we need to provide this overlay to work on non prod environments,
# which the CLOUDSDK_API_ENDPOINT_OVERRIDES_CONTAINER will cause.
# Patterns to replace:
# - {{.ProjectId}} needs to be replaced with the project the cluster is in.
# - {{.Location}} needs to be replaced with the location (region or zone) the cluster is in.
# - {{.Cluster}} needs to be replaced with the cluster name that is having ASM installed on it.
# - {{.Hostname}} needs to be replaced by the hostname of the CLOUDSDK_API_ENDPOINT_OVERRIDES_CONTAINER value.
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  components:
    pilot:
      k8s:
        env:
        - name: GKE_CLUSTER_URL
          value: "https://staging-container.sandbox.googleapis.com/v1/projects/{{.ProjectId}}/locations/{{.Location}}/clusters/{{.Cluster}}"
        - name: SPIFFE_BUNDLE_ENDPOINTS
          value: "{{.ProjectId}}.svc.id.goog|https://storage.googleapis.com/mesh-ca-resources/spiffe_bundle.json"
        - name: ENABLE_STACKDRIVER_MONITORING
          value: "true"
        - name: TOKEN_AUDIENCES
          value: "{{.ProjectId}}.svc.id.goog"
        - name: PILOT_ENABLE_WORKLOAD_ENTRY_AUTOREGISTRATION
          value: "true"
  meshConfig:
    defaultConfig:
      proxyMetadata:
        GKE_CLUSTER_URL: "https://{{.Hostname}}/v1/projects/{{.ProjectId}}/locations/{{.Location}}/clusters/{{.Cluster}}"
